<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Menu Scan Results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/hero.css">
    <link rel="stylesheet" href="styles/how-it-works.css">
    <link rel="stylesheet" href="styles/social-proof.css">
    <link rel="stylesheet" href="styles/pricing.css">
    <link rel="stylesheet" href="styles/shared-footer.css">
    <link rel="stylesheet" href="styles/modal.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">ðŸ¤”</div>
                    <div class="logo-text">What The Menu?</div>
                </a>
                <nav class="nav">
                    <a href="#how-it-works" class="nav-link">How It Works</a>
                    <a href="#pricing" class="nav-link">Pricing</a>
                </nav>
                <div class="header-actions">
                    <a href="login.html" class="user-icon">ðŸ‘¤</a>
                </div>
            </div>
        </div>
    </header>

    <main style="max-width: 800px; margin: 2rem auto; padding: 1rem;">
        <h1>Menu Scan Results</h1>
        <div id="menu-sections"></div>
    </main>

    <footer style="background: #e2e8f0; border-top: 1px solid rgba(8, 145, 178, 0.3); margin-top: auto;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 3rem 1.5rem 2rem;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 3rem; margin-bottom: 2rem;">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0891b2, #06b6d4); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);">ðŸ¤”</div>
                        <div style="font-family: 'Nunito', sans-serif; font-size: 1.4rem; font-weight: 900; color: #0891b2; letter-spacing: -0.5px;">What The Menu?</div>
                    </div>
                    <p style="font-size: 1rem; color: #64748b; line-height: 1.6; max-width: 300px; font-weight: 500; margin: 0;">
                        Never wonder what's on the menu again.
                    </p>
                </div>
                <div>
                    <h3 style="font-family: 'Nunito', sans-serif; font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 1rem;">Legal</h3>
                    <a href="privacy.html" style="color: #64748b; text-decoration: none; font-size: 0.95rem; font-weight: 500; padding: 0.25rem 0; transition: color 0.3s ease; display: block;">Privacy Policy</a>
                    <a href="terms.html" style="color: #64748b; text-decoration: none; font-size: 0.95rem; font-weight: 500; padding: 0.25rem 0; transition: color 0.3s ease; display: block;">Terms of Service</a>
                    <a href="contact.html" style="color: #64748b; text-decoration: none; font-size: 0.95rem; font-weight: 500; padding: 0.25rem 0; transition: color 0.3s ease; display: block;">Contact</a>
                </div>
                <div>
                    <h3 style="font-family: 'Nunito', sans-serif; font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 1rem;">Languages</h3>
                    <div style="margin: 1rem 0;">
                        <span style="color: #64748b; font-size: 0.9rem; line-height: 1.5; font-weight: 500;">English, Spanish, French, Italian, German, Japanese, Korean, Chinese</span>
                    </div>
                    <p style="color: #64748b; font-size: 0.95rem; font-weight: 500; margin: 0;">+ 42 more languages</p>
                </div>
            </div>
            <div style="border-top: 1px solid #e2e8f0; padding-top: 2rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #64748b;">
                <div style="font-weight: 500;">
                    Â© 2025 What The Menu? All rights reserved.
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #10b981;">
                    ðŸ”’ Secure payments by Stripe
                </div>
            </div>
        </div>
    </footer>

    <script>
    // Helper to get userId and scanId from sessionStorage
    function getUserAndScanId() {
        return {
            userId: sessionStorage.getItem('userId'),
            scanId: sessionStorage.getItem('scanId')
        };
    }

    // Render the menu and set up click handlers
    function renderMenu(sections, userId, scanId) {
        const menuContainer = document.getElementById('menu-sections');
        menuContainer.innerHTML = '';
        sections.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.innerHTML = `<h3>${section.section || section.name}</h3><ul></ul>`;
            const ul = sectionDiv.querySelector('ul');
            section.dishes.forEach(dish => {
                ul.innerHTML += `
                    <li>
                        <span class="dish-name" 
                              data-dish-name="${dish.name}" 
                              data-dish-desc="${dish.description || ''}"
                              style="cursor:pointer; color:#0891b2; text-decoration:underline;">
                            ${dish.name}
                        </span>
                        <span class="dish-explanation" style="margin-left:10px; color:#64748b;"></span>
                    </li>
                `;
            });
            menuContainer.appendChild(sectionDiv);
        });
        setupDishClickHandlers(userId, scanId);
    }

    // Click handler for dish explanations
    function setupDishClickHandlers(userId, scanId) {
        document.querySelectorAll('.dish-name').forEach(el => {
            el.addEventListener('click', async function() {
                const dishName = this.dataset.dishName;
                const dishDesc = this.dataset.dishDesc || '';
                const explanationEl = this.nextElementSibling;

                explanationEl.textContent = 'Loading explanation...';

                const response = await fetch('/.netlify/functions/get-dish-explanation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: dishName,
                        description: dishDesc,
                        userId: userId,
                        scanId: scanId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    explanationEl.textContent = result.explanation;
                } else {
                    explanationEl.textContent = result.error || 'Could not fetch explanation.';
                }
            });
        });
    }

    // On page load, render the menu
    document.addEventListener('DOMContentLoaded', function() {
        const menuResults = JSON.parse(sessionStorage.getItem('menuResults') || '{}');
        const { userId, scanId } = getUserAndScanId();
        const sections = menuResults.sections || [];
        if (!userId || !scanId) {
            document.getElementById('menu-sections').innerHTML = '<p style="color:red;">User or scan information missing. Please rescan your menu.</p>';
            return;
        }
        renderMenu(sections, userId, scanId);
    });
    </script>
</body>
</html>